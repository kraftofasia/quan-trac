<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o D·ªØ li·ªáu Quan tr·∫Øc</title>
    <style>
        /* CSS M·ªöI: ƒê·ªãnh d·∫°ng b√°o c√°o d·∫°ng th·∫ª (Card View) */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f9; }
        #data-container { max-width: 1200px; margin: auto; }
        
        /* Ti√™u ƒë·ªÅ Tr·∫°m */
        .station-header { 
            background-color: #ffffff; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            margin-bottom: 10px;
        }
        .station-header h3 { color: #007bff; margin: 0; font-size: 1.5em; display: inline-block; }
        .station-header p { color: #6c757d; margin: 5px 0 0 0; font-size: 0.9em; }

        /* Container cho c√°c Th·∫ª ƒëo l∆∞·ªùng */
        .measurement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); /* 3 ho·∫∑c 4 c·ªôt tr√™n m√†n h√¨nh l·ªõn */
            gap: 15px;
            margin-bottom: 30px;
            padding-top: 10px;
        }

        /* ƒê·ªãnh d·∫°ng Th·∫ª ƒêo l∆∞·ªùng (Card) */
        .measure-card {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 5px solid #007bff; /* M√†u s·∫Øc trang tr√≠ */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
        }
        .measure-card .key-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 5px;
        }
        .measure-card .key-name {
            font-size: 0.9em;
            color: #6c757d;
            font-weight: bold;
        }
        .measure-card .value-display {
            font-size: 1.8em;
            font-weight: bold;
            color: #28a745; /* M√†u xanh l√° c√¢y cho gi√° tr·ªã */
            line-height: 1.1;
        }
        .measure-card .unit-display {
            font-size: 1em;
            color: #6c757d;
            font-weight: normal;
        }
        .measure-card .limit-info {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #28a745; /* Gi·∫£ ƒë·ªãnh tr·∫°ng th√°i T·ªët/Trong gi·ªõi h·∫°n */
            display: inline-block;
        }
        .error { color: #dc3545; }
        .loading { color: #f90; }
    </style>
</head>
<body>
    <div id="data-container">
        </div>

    <script>
        // 1. Khai b√°o URL Endpoint v√† Header
        const API_URL = 'https://global-api.ilotusland.com/calc/share-api/station-auto/newest-data?id=6690f38464486d001b17fb33&province=5f6433e9ad4165001151f896&stationType=5a936ffd06fc4f3390afb7c7&stationKeys=KT_MARUBENI2_1,KT_MARUBENI1&measuringList=CO,Luu_Luong,NOx,O2,Bui,Ap_Suat,SO2,Nhiet_Do&dataType=origin';
        const SECRET_KEY = 'Eq4h6F1p6x4Zv630W-C4lq_JLrD53ElKu7002s_2R_2Y'; 

        const container = document.getElementById('data-container'); 

        async function loadEmissionData() {
            if (!container) {
                console.error("L·ªói FATAL: Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ HTML c√≥ ID l√† 'data-container'.");
                return;
            }

            const requestOptions = {
                method: 'GET',
                headers: {
                    'secret-key': SECRET_KEY,
                    'Content-Type': 'application/json' 
                }
            };

            try {
                // üí° CH·ªàNH S·ª¨A: Thay v√¨ hi·ªÉn th·ªã th√¥ng b√°o "ƒêang t·∫£i..." trong container,
                // ch√∫ng ta ch·ªâ n√™n x√≥a n·ªôi dung c≈© (n·∫øu c√≥) tr∆∞·ªõc khi t·∫£i.
                // Tuy nhi√™n, v√¨ ch√∫ng ta mu·ªën lo·∫°i b·ªè ho√†n to√†n, ta ch·ªâ c·∫ßn g·ªçi fetch ngay.
                // N·∫øu mu·ªën gi·ªØ th√¥ng b√°o l·ªói (error), ta v·∫´n c·∫ßn h√†m n√†y.
                // Ta t·∫°m th·ªùi KH√îNG ƒë·∫∑t th√¥ng b√°o t·∫£i v√†o ƒë√¢y n·ªØa.
                
                const response = await fetch(API_URL, requestOptions);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`L·ªói HTTP ${response.status}: ${errorText.substring(0, 100)}...`);
                }

                const data = await response.json();
                displayData(data);

            } catch (error) {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu API:", error);
                // Gi·ªØ l·∫°i th√¥ng b√°o l·ªói n·∫øu t·∫£i th·∫•t b·∫°i
                container.innerHTML = `<p class="error" style="margin-left: 0; padding: 15px; border: 1px solid #dc3545; border-radius: 4px;">‚ùå L·ªói k·∫øt n·ªëi: ${error.message}. Ki·ªÉm tra kh√≥a v√† CORS.</p>`;
            }
        }

        // H√†m t·∫°o c√°c ph·∫ßn t·ª≠ HTML ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu
        function displayData(apiResponse) {
            // ƒê·∫£m b·∫£o container tr·ªëng tr∆∞·ªõc khi v·∫Ω
            container.innerHTML = ''; 

            const stationsData = apiResponse; 

            if (Array.isArray(stationsData) && stationsData.length > 0) {
                
                stationsData.forEach(station => {
                    
                    // --- 1. PH·∫¶N ƒê·∫¶U B√ÅO C√ÅO (HEADER) ---
                    const stationContainer = document.createElement('div');
                    stationContainer.classList.add('station-report');

                    // Logic c·∫≠p nh·∫≠t T√äN TR·∫†M
                    let stationName = station.name || station.key || 'Tr·∫°m kh√¥ng r√µ';
                    
                    if (station.key === 'KT_MARUBENI1') {
                        stationName = 'Nh√† M√°y Gi·∫•y KOA 1 - KCN Chuy√™n S√¢u Ph√∫ M·ªπ 3';
                    } else if (station.key === 'KT_MARUBENI2_1') {
                        stationName = 'Nh√† M√°y Gi·∫•y KOA 2 - KCN Chuy√™n S√¢u Ph√∫ M·ªπ 3';
                    }
                    
                    // Chu·∫©n h√≥a ƒë·ªãa ch·ªâ
                    let displayAddress = 'N/A';
                    if (station.key === 'KT_MARUBENI1' || station.key === 'KT_MARUBENI2_1') {
                        displayAddress = 'Ph∆∞·ªõc Ho√†, TP HCM, Vi·ªát Nam';
                    } else {
                        displayAddress = station.address || 'N/A';
                    }
                    
                    // Th·ªùi gian l·∫•y m·∫´u
                    let timeString = 'N/A';
                    if(station.receivedAt) {
                         timeString = new Date(station.receivedAt).toLocaleString('vi-VN', { 
                            day: '2-digit', month: '2-digit', year: 'numeric', 
                            hour: '2-digit', minute: '2-digit', hour12: false 
                         });
                    }

                    // Th√™m ti√™u ƒë·ªÅ tr·∫°m (ƒê√£ b·ªè m√£ tr·∫°m)
                    stationContainer.innerHTML += `
                        <div class="station-header">
                            <h3>üì° ${stationName}</h3>
                            <p>ƒê·ªãa ch·ªâ: ${displayAddress} | Th·ªùi gian l·∫•y m·∫´u: <strong>${timeString}</strong></p>
                        </div>
                    `;
                    
                    // --- 2. PH·∫¶N TH·∫∫ ƒêO L∆Ø·ªúNG (CARDS) ---
                    const logs = station.measuringLogs;
                    const grid = document.createElement('div');
                    grid.classList.add('measurement-grid');

                    if (logs && typeof logs === 'object') {
                        
                        // L·∫∑p qua T·∫§T C·∫¢ c√°c kh√≥a (v√≠ d·ª•: CO, NOx, SO2)
                        Object.keys(logs).forEach(key => {
                            const measure = logs[key]; 
                            
                            // ƒê·ªãnh d·∫°ng gi√° tr·ªã
                            const value = measure.value;
                            const valueDisplay = (value !== null && value !== undefined) 
                                                     ? Number(value).toFixed(2) : 'N/A';
                            
                            // LOGIC: X√¢y d·ª±ng chu·ªói gi·ªõi h·∫°n linh ho·∫°t
                            let limitText = '';
                            const minL = measure.minLimit;
                            const maxL = measure.maxLimit;
                            
                            if (minL !== null && maxL !== null) {
                                limitText = `Gi·ªõi h·∫°n: ${minL} ‚Üí ${maxL}`;
                            } else if (minL !== null) {
                                limitText = `Gi·ªõi h·∫°n: ‚â• ${minL}`;
                            } else if (maxL !== null) {
                                limitText = `Gi·ªõi h·∫°n: ‚â§ ${maxL}`;
                            } else {
                                limitText = `Gi·ªõi h·∫°n: N/A`;
                            }
                            // Th√™m kho·∫£ng tr·∫Øng cho d·ªÖ ƒë·ªçc n·∫øu l√† kho·∫£ng
                            const limitDisplay = limitText.replace('‚Üí', ' ‚Üí '); 


                            // T·∫°o th·∫ª ƒëo l∆∞·ªùng
                            const card = document.createElement('div');
                            card.classList.add('measure-card');

                            // X√¢y d·ª±ng n·ªôi dung th·∫ª
                            card.innerHTML = `
                                <div class="key-info">
                                    <span class="key-name">${key} (${measure.name})</span>
                                    <span class="status-dot"></span>
                                </div>
                                <div class="value-display-container">
                                    <span class="value-display">${valueDisplay}</span>
                                    <span class="unit-display">${measure.unit || ''}</span>
                                </div>
                                <div class="limit-info">
                                    ${limitDisplay}
                                </div>
                            `;
                            
                            grid.appendChild(card);
                        });
                        stationContainer.appendChild(grid);
                    } else {
                         stationContainer.innerHTML += `<p style="margin-top: 15px;">Kh√¥ng c√≥ d·ªØ li·ªáu ƒëo l∆∞·ªùng chi ti·∫øt.</p>`;
                    }
                    
                    container.appendChild(stationContainer);
                    container.appendChild(document.createElement('hr')); 
                });
                
            } else {
                 container.innerHTML += '<p>Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu tr·∫°m quan tr·∫Øc n√†o trong ph·∫£n h·ªìi API.</p>';
            }
        }
        // B·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫£i d·ªØ li·ªáu
        loadEmissionData();
    </script>
</body>
</html>
